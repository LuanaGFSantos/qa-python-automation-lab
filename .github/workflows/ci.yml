
name: CI - Testes Automatizados

on:
  push:
  pull_request:

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov

      - name: Executar testes com cobertura (XML e terminal)
        run: |
          PYTHONPATH=. pytest -vv \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=0

      - name: Gerar relatório HTML de cobertura
        run: |
          PYTHONPATH=. pytest -q \
            --cov=app \
            --cov-report=html:coverage_html \
            --cov-report=term

      - name: Upload do relatório de cobertura (HTML e XML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage_html
            coverage.xml

      # ---------------------------
      # (Opcional - adicionar depois)
      # Passos para badge dinâmico:
      #
      # - name: Extrair percentual de cobertura do XML
      #   id: coverage
      #   run: |
      #     RATE=$(python - << 'PY'
      # import xml.etree.ElementTree as ET
      # tree = ET.parse('coverage.xml')
      # rate = float(tree.getroot().attrib.get('line-rate', 0.0))
      # print(int(round(rate * 100)))
      # PY
      # )
      #     echo "percent=$RATE" >> $GITHUB_OUTPUT
      #
      # - name: Gerar badge SVG de cobertura
      #   run: |
      #     PCT="${{ steps.coverage.outputs.percent }}"
      #     COLOR="red"
      #     if [ "$PCT" -ge 90 ]; then COLOR="brightgreen"; elif [ "$PCT" -ge 80 ]; then COLOR="green"; elif [ "$PCT" -ge 70 ]; then COLOR="yellowgreen"; elif [ "$PCT" -ge 60 ]; then COLOR="yellow"; elif [ "$PCT" -ge 50 ]; then COLOR="orange"; fi
      #     cat > coverage-badge.svg <<'SVG'
      # <svg xmlns="http://www.w3.org/2000/svg" width="140" height="20" role="img" aria-label="coverage">
      #   <linearGradient id="a" x2="0" y2="100%"><stop offset="0" stop-color="#fff" stop-opacity=".7"/><stop offset=".1" stop-opacity=".1"/><stop offset=".9" stop-opacity=".3"/></linearGradient>
      #   <mask id="m"><rect width="140" height="20" rx="3" fill="#fff"/></mask>
      #   <g mask="url(#m)">
      #     <rect width="70" height="20" fill="#555"/>
      #     <rect x="70" width="70" height="20" fill="#00"/>
      #     <rect width="140" height="20" fill="url(#a)"/>
      #   </g>
      #   <g fill="#fff" text-anchor="middle" font-family="Verdana,DejaVu Sans,sans-serif" font-size="11">
      #     <text x="35" y="14">coverage</text>
      #     <text id="pct" x="105" y="14"></text>
      #   </g>
      # </svg>
      # SVG
      #     sed -i "s/fill=\"#00\"/fill=\"${COLOR}\"/" coverage-badge.svg
      #     sed -i "s|<text id=\"pct\" x=\"105\" y=\"14\"></text>|<text id=\"pct\" x=\"105\" y=\"14\">${PCT}%</text>|" coverage-badge.svg
      #
      # - name: Criar Pull Request com o badge atualizado
      #   uses: peter-evans/create-pull-request@v6
      #   with:
      #     commit-message: "docs: atualiza badge de cobertura para ${{ steps.coverage.outputs.percent }}%"
      #     title: "Atualiza badge de cobertura"
      #     body: "Atualiza coverage-badge.svg com a última medição do CI."
      #     branch: "chore/update-coverage-badge"
      #     add-paths: |
      #       coverage-badge.svg
